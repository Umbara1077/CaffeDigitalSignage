<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Cache control headers -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-auth.js"></script>
    <script src="firebaseConfig.js"></script>
    <script src="script.js"></script>
    <script src="hoursConfig.js"></script>
    <script src="network-status.js?v=1.1" defer></script>
    <link rel="icon" href="dolce-logo.png" type="image/x-icon">
</head>
<body>

    <div id="video-container" style="display: none;">
        <video id="intro-video" autoplay muted>
            <source src="" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>
    
    <div id="home-page">
        <main>
            <div class="menu-grid">
                
            </div>
        </main>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let retryAttempts = 0;
        const maxRetries = 3;
        const cacheExpiryTime = 10 * 60 * 1000; // 10 minutes in milliseconds

        // Simple caching functions
        function getCachedBusinessHours() {
            try {
                const cached = localStorage.getItem('businessHours');
                const timestamp = localStorage.getItem('businessHoursTimestamp');
                
                if (cached && timestamp) {
                    const age = Date.now() - parseInt(timestamp);
                    if (age < cacheExpiryTime) {
                        console.log("üìã Using cached business hours");
                        return JSON.parse(cached);
                    } else {
                        console.log("‚è∞ Cached business hours expired");
                        // Clear expired cache
                        localStorage.removeItem('businessHours');
                        localStorage.removeItem('businessHoursTimestamp');
                    }
                }
            } catch (error) {
                console.error("‚ùå Error reading cache:", error);
            }
            return null;
        }

        function setCachedBusinessHours(businessHours) {
            try {
                localStorage.setItem('businessHours', JSON.stringify(businessHours));
                localStorage.setItem('businessHoursTimestamp', Date.now().toString());
                console.log("üíæ Business hours cached successfully");
            } catch (error) {
                console.error("‚ùå Error setting cache:", error);
            }
        }

        function getFallbackBusinessHours() {
            console.log("üîÑ Using fallback business hours");
            return {
                openHour: 7,
                openMinute: 0,
                closeHour: 20,
                closeMinute: 0
            };
        }

        function fetchBusinessHours(callback) {
            const attemptFetch = (attempt = 0) => {
                console.log(`üì° Attempting to fetch business hours (attempt ${attempt + 1}/${maxRetries})`);
                
                hoursDB.collection("business_hours").doc("hours").get()
                    .then((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            console.log("üì¢ Fetched Business Hours:", data);

                            if (!data.openTime || !data.closeTime) {
                                console.error("‚ùå Missing openTime or closeTime in Firestore!");
                                // Try cached data or fallback
                                const cachedHours = getCachedBusinessHours();
                                if (cachedHours) {
                                    callback(cachedHours);
                                } else {
                                    callback(getFallbackBusinessHours());
                                }
                                return;
                            }

                            // Ensure openTime and closeTime are numbers
                            const openTime = parseInt(data.openTime, 10);
                            const closeTime = parseInt(data.closeTime, 10);

                            // Convert HHMM format to hour and minute values
                            const openHour = Math.floor(openTime / 100);
                            const openMinute = openTime % 100;
                            const closeHour = Math.floor(closeTime / 100);
                            const closeMinute = closeTime % 100;

                            console.log(`‚úÖ Open Time: ${openHour}:${openMinute}`);
                            console.log(`‚úÖ Close Time: ${closeHour}:${closeMinute}`);

                            const businessHours = { openHour, openMinute, closeHour, closeMinute };
                            
                            // Cache the successful result
                            setCachedBusinessHours(businessHours);
                            
                            callback(businessHours);
                            retryAttempts = 0; // Reset on success
                        } else {
                            console.error("‚ùå Business hours document not found!");
                            // Try cached data or fallback
                            const cachedHours = getCachedBusinessHours();
                            if (cachedHours) {
                                callback(cachedHours);
                            } else {
                                callback(getFallbackBusinessHours());
                            }
                        }
                    })
                    .catch((error) => {
                        console.error(`‚ùå Firestore fetch error (attempt ${attempt + 1}):`, error);
                        
                        if (attempt < maxRetries - 1) {
                            // Retry with exponential backoff
                            const delay = Math.pow(2, attempt) * 1000; // 1s, 2s, 4s
                            console.log(`üîÑ Retrying in ${delay}ms...`);
                            setTimeout(() => attemptFetch(attempt + 1), delay);
                        } else {
                            console.error("‚ùå Max retries reached for business hours fetch");
                            // Try cached data first, then fallback
                            const cachedHours = getCachedBusinessHours();
                            if (cachedHours) {
                                console.log("üìã Using cached business hours after fetch failure");
                                callback(cachedHours);
                            } else {
                                console.log("üîÑ Using fallback business hours after fetch failure");
                                callback(getFallbackBusinessHours());
                            }
                        }
                    });
            };
            
            attemptFetch();
        }

        function checkTime(businessHours) {
            const now = new Date();
            const day = now.getDay();
            const hours = now.getHours();
            const minutes = now.getMinutes();

            const isBusinessDay = (day === 0 || (day >= 3 && day <= 7)); // Open on Wed-Sun

            const { openHour, openMinute, closeHour, closeMinute } = businessHours;

            // Check if current time is within open hours
            const isOpenHours = isBusinessDay &&
                                (hours > openHour || (hours === openHour && minutes >= openMinute)) &&
                                (hours < closeHour || (hours === closeHour && minutes < closeMinute));

            console.log(`üïí NOW: ${hours}:${minutes} | OPEN: ${openHour}:${openMinute} - ${closeHour}:${closeMinute} | isOpenHours: ${isOpenHours}`);
            console.log(`‚úÖ Is Today a Business Day? ${isBusinessDay}`);
            
            if (!isOpenHours) {
                console.log("üî¥ Store is CLOSED - Redirecting to early.html");
                setTimeout(() => { window.location.href = "early.html"; }, 500);
            }
        }

        // Network status monitoring
        function handleOnline() {
            console.log("üåê Network connection restored");
            retryAttempts = 0; // Reset retry attempts when back online
        }

        function handleOffline() {
            console.log("üì¥ Network connection lost - will use cached data");
        }

        // Add network event listeners
        window.addEventListener('online', handleOnline);
        window.addEventListener('offline', handleOffline);

        // Enhanced interval function with better error handling
        function setupBusinessHoursCheck() {
            fetchBusinessHours(checkTime);
            
            // Set up interval with error boundary
            const intervalId = setInterval(() => {
                try {
                    fetchBusinessHours(checkTime);
                } catch (error) {
                    console.error("‚ùå Error in business hours check interval:", error);
                    // Continue with cached or fallback data
                    const cachedHours = getCachedBusinessHours();
                    if (cachedHours) {
                        checkTime(cachedHours);
                    } else {
                        checkTime(getFallbackBusinessHours());
                    }
                }
            }, 60000);

            // Clean up interval on page unload
            window.addEventListener('beforeunload', () => {
                clearInterval(intervalId);
            });
        }

        // Initialize with error handling
        try {
            setupBusinessHoursCheck();
        } catch (error) {
            console.error("‚ùå Critical error during initialization:", error);
            // Use fallback hours if everything fails
            checkTime(getFallbackBusinessHours());
        }
    });
    </script>   

   <!-- <script>
        document.addEventListener('DOMContentLoaded', () => {
            function checkTime() {
                const now = new Date();
                const day = now.getDay();
                const hours = now.getHours();
                const minutes = now.getMinutes();
    
                // Define business days and open hours
                const isWednesday = (day === 3); // Wednesday only
                const isThursday = (day === 4); // Thursday only
                const isFridayToSunday = (day === 0 || (day >= 5 && day <= 6)); // Include Sunday in Friday-Sunday range
    
                // Open hours for each day
                const isOpenHoursWednesdayThursday = (hours >= 7 && (hours < 20 || (hours === 20 && minutes === 0)));
                const isOpenHoursFridayToSunday = (hours >= 7 && (hours < 20 || (hours === 20 && minutes === 0)));
    
                // Determine if it's a business day and within open hours
                const isBusinessDay = isWednesday || isThursday || isFridayToSunday;
                const isOpenHours = ((isWednesday || isThursday) && isOpenHoursWednesdayThursday) || 
                                    (isFridayToSunday && isOpenHoursFridayToSunday);
    
                const currentPage = window.location.pathname;
    
                // Console logs for tracking
                console.log(`index.html - Day: ${day}, Hours: ${hours}:${minutes}`);
                console.log(`index.html - Is Business Day: ${isBusinessDay}, Is Open Hours: ${isOpenHours}`);
                console.log(isWednesday ? "Time Zone: Wednesday (7 AM to 8 PM)"
                                        : isThursday ? "Time Zone: Thursday (7 AM to 8 PM)"
                                        : isFridayToSunday ? "Time Zone: Friday-Sunday (7 AM to 8 PM)" : "");
    
                if (!isBusinessDay || !isOpenHours) {
                    if (currentPage !== "/early.html") {
                        console.log("Redirecting to early.html");
                        setTimeout(() => {
                            window.location.href = "early.html";
                        }, 500); // Small delay to stabilize the redirection
                    }
                } else {
                    if (currentPage === "/early.html") {
                        console.log("Redirecting to index.html");
                        setTimeout(() => {
                            window.location.href = "index.html";
                        }, 500); // Small delay to stabilize the redirection
                    }
                }
            }
    
            checkTime();
            setInterval(checkTime, 60000); // Check every minute
        });
    </script>    -->
    
</body>
</html>